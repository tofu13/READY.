import inspect
from timing import timing
from hardware.machine import DefaultMachine

machine = DefaultMachine()


def _benchmark_cpu():
    """
            LDX #$0F
    loop:   STX $C000
            DEX
            BNE loop
            BRK
    """

    machine.memory.set_slice(0x0801, [0xa2, 0x0f, 0x8e, 0x00, 0xC0, 0xca, 0xd0, 0xfa, 0x00])
    with timing() as t:
        t.repeat(10000, machine.run, 0x0801)
    print(t)


def _benchmark_cpu_BRK():
    """
            BRK
    """
    machine.memory[0x0800] = 0x00
    with timing() as t:
        t.repeat(10000, machine.run, 0x0800)
    print(t)


def benchmark_color_bars():
    machine.memory.set_slice(0x0800,
                             [0xa9, 0x00, 0x85, 0xfb, 0x85, 0xfd, 0xa9, 0x04,
                              0x85, 0xfc, 0xa9, 0xd8, 0x85, 0xfe, 0xa2, 0x00,
                              0xa0, 0x27, 0xa9, 0xa0, 0x91, 0xfb, 0x8a, 0x91,
                              0xfd, 0x88, 0x10, 0xf6, 0x18, 0xa9, 0x28, 0x65,
                              0xfb, 0x85, 0xfb, 0x85, 0xfd, 0x90, 0x04, 0xe6,
                              0xfc, 0xe6, 0xfe, 0xe8, 0xe0, 0x19, 0xd0, 0xe0,
                              0x00]
                             )
    with timing() as t:
        t.repeat(4, machine.run, 0x0800)
    print(t)


def _benchmark_color_bars_2():
    machine.memory.set_slice(0x0800,
                             [0x01, 0x08, 0xa9, 0x00, 0x85, 0xfb, 0x85, 0xfd,
                              0xa9, 0x04, 0x85, 0xfc, 0xa9, 0xd8, 0x85, 0xfe,
                              0xa2, 0x00, 0xa0, 0x27, 0x8a, 0x91, 0xfd, 0xa9,
                              0xa0, 0x91, 0xfb, 0x88, 0x10, 0xf6, 0x18, 0xa9,
                              0x28, 0x65, 0xfb, 0x85, 0xfb, 0x85, 0xfd, 0x90,
                              0x04, 0xe6, 0xfc, 0xe6, 0xfe, 0xe8, 0xe0, 0x19,
                              0xd0, 0xe0, 0x20, 0x44, 0xe5, 0xa9, 0x00, 0x85,
                              0xfb, 0x85, 0xfd, 0xa9, 0x04, 0x85, 0xfc, 0xa9,
                              0xd8, 0x85, 0xfe, 0xa0, 0x1f, 0xb1, 0xfb, 0x69,
                              0x01, 0x91, 0xfb, 0xd0, 0xf8, 0x88, 0xd0, 0xf5,
                              0x20, 0x44, 0xe5, 0x00]
                             )
    with timing() as t:
        t.repeat(2, machine.run, 0x0800)
    print(t)


# Run all benchmarks* a la pytest
for benchmark in [meth for meth_name, meth in inspect.currentframe().f_locals.items() if
                  meth_name.startswith("benchmark")]:
    benchmark()
